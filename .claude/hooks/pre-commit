#!/bin/bash

# pre-commit hook anti-drift
# VÃ©rifie la cohÃ©rence de la documentation avant chaque commit

set -e

# Couleurs
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

APP_HOME="$(git rev-parse --show-toplevel)"
ERRORS=0

echo "ðŸ” VÃ©rification anti-drift..."

# Fonction pour compter occurrences
count_pattern() {
    local file="$1"
    local pattern="$2"
    grep -c "$pattern" "$file" 2>/dev/null || echo "0"
}

# 1. VÃ©rifier agent count cohÃ©rent (6/7)
echo -n "   Checking agent count... "
CLAUDE_MD_COUNT=$(count_pattern "$APP_HOME/CLAUDE.md" "Agents actuels: 6/7")
PROJECT_INDEX_COUNT=$(count_pattern "$APP_HOME/PROJECT-INDEX.md" "6/7")
AGENTS_CLAUDE_COUNT=$(count_pattern "$APP_HOME/projects/claude-code-agents/CLAUDE.md" "6/7")

if [ "$CLAUDE_MD_COUNT" -eq 0 ] || [ "$PROJECT_INDEX_COUNT" -eq 0 ] || [ "$AGENTS_CLAUDE_COUNT" -eq 0 ]; then
    echo -e "${RED}âœ—${NC}"
    echo -e "   ${RED}ERROR: Agent count drift detected!${NC}"
    echo "   Expected: 6/7 in all files"
    echo "   Found in CLAUDE.md: $CLAUDE_MD_COUNT occurrences"
    echo "   Found in PROJECT-INDEX.md: $PROJECT_INDEX_COUNT occurrences"
    echo "   Found in claude-code-agents/CLAUDE.md: $AGENTS_CLAUDE_COUNT occurrences"
    ERRORS=$((ERRORS + 1))
else
    echo -e "${GREEN}âœ“${NC}"
fi

# 2. VÃ©rifier core tools count (16)
echo -n "   Checking core tools count... "
ACTUAL_TOOLS=$(ls -1 "$APP_HOME/core/bin/" 2>/dev/null | wc -l | tr -d ' ')
DOCUMENTED_COUNT=$(count_pattern "$APP_HOME/PROJECT-INDEX.md" "16 scripts")

if [ "$ACTUAL_TOOLS" -ne 16 ] || [ "$DOCUMENTED_COUNT" -eq 0 ]; then
    echo -e "${RED}âœ—${NC}"
    echo -e "   ${RED}ERROR: Core tools count drift detected!${NC}"
    echo "   Actual tools in core/bin/: $ACTUAL_TOOLS"
    echo "   Expected in documentation: 16"
    echo "   Documented count mentions: $DOCUMENTED_COUNT"
    ERRORS=$((ERRORS + 1))
else
    echo -e "${GREEN}âœ“${NC}"
fi

# 3. VÃ©rifier que sync-context.sh est marquÃ© obsolÃ¨te
echo -n "   Checking sync-context.sh obsolete marking... "
OBSOLETE_COUNT=$(grep -r "sync-context.sh.*obsolÃ¨te\|sync-context.sh.*OBSOLÃˆTE" "$APP_HOME" --include="*.md" 2>/dev/null | wc -l | tr -d ' ')

if [ "$OBSOLETE_COUNT" -lt 2 ]; then
    echo -e "${YELLOW}âš ${NC}"
    echo -e "   ${YELLOW}WARNING: sync-context.sh should be marked obsolete in documentation${NC}"
    echo "   Found $OBSOLETE_COUNT mentions"
    # Not a blocker, just a warning
else
    echo -e "${GREEN}âœ“${NC}"
fi

# 4. VÃ©rifier que les symlinks existent
echo -n "   Checking symlinks exist... "
SYMLINKS_OK=1
for file in agents.md gemini.md opencode.md bin; do
    if [ ! -L "$APP_HOME/$file" ]; then
        if [ "$SYMLINKS_OK" -eq 1 ]; then
            echo -e "${RED}âœ—${NC}"
            SYMLINKS_OK=0
        fi
        echo -e "   ${RED}ERROR: $file is not a symlink!${NC}"
        ERRORS=$((ERRORS + 1))
    fi
done
if [ "$SYMLINKS_OK" -eq 1 ]; then
    echo -e "${GREEN}âœ“${NC}"
fi

# 5. VÃ©rifier que PROJECT-INDEX.md existe et n'est pas vide
echo -n "   Checking PROJECT-INDEX.md... "
if [ ! -f "$APP_HOME/PROJECT-INDEX.md" ]; then
    echo -e "${RED}âœ—${NC}"
    echo -e "   ${RED}ERROR: PROJECT-INDEX.md not found!${NC}"
    ERRORS=$((ERRORS + 1))
elif [ ! -s "$APP_HOME/PROJECT-INDEX.md" ]; then
    echo -e "${RED}âœ—${NC}"
    echo -e "   ${RED}ERROR: PROJECT-INDEX.md is empty!${NC}"
    ERRORS=$((ERRORS + 1))
else
    echo -e "${GREEN}âœ“${NC}"
fi

# 6. VÃ©rifier que CHANGELOG.md suit le format Keep a Changelog
echo -n "   Checking CHANGELOG.md format... "
if ! grep -q "### Added\|### Changed\|### Fixed\|### Removed" "$APP_HOME/CHANGELOG.md" 2>/dev/null; then
    echo -e "${YELLOW}âš ${NC}"
    echo -e "   ${YELLOW}WARNING: CHANGELOG.md may not follow Keep a Changelog format${NC}"
else
    echo -e "${GREEN}âœ“${NC}"
fi

# 7. VÃ©rifier doublons dans TODO.md (si modifiÃ©)
if git diff --cached --name-only | grep -q "TODO.md"; then
    echo -n "   Checking TODO.md duplicates... "
    if [ -x "$APP_HOME/projects/todo-manager/bin/check-duplicates" ]; then
        if "$APP_HOME/projects/todo-manager/bin/check-duplicates" > /dev/null 2>&1; then
            echo -e "${GREEN}âœ“${NC}"
        else
            echo -e "${RED}âœ—${NC}"
            echo -e "   ${RED}ERROR: Duplicate todos detected in TODO.md!${NC}"
            echo ""
            "$APP_HOME/projects/todo-manager/bin/check-duplicates"
            echo ""
            ERRORS=$((ERRORS + 1))
        fi
    else
        echo -e "${YELLOW}âš ${NC}"
        echo -e "   ${YELLOW}WARNING: check-duplicates script not found or not executable${NC}"
    fi
fi

# 8. VÃ©rifier documentation synchronisÃ©e (CODE-DOC-MAP)
CODE_DOC_MAP="$APP_HOME/SecondBrain/wiki/CODE-DOC-MAP.md"
if [ -f "$CODE_DOC_MAP" ]; then
    echo -n "   Checking code-doc sync... "

    # Fichiers code changÃ©s (relatifs au HOME)
    CHANGED_FILES=$(git diff --cached --name-only)
    DOC_ERRORS=0
    MISSING_DOCS=""

    # Pour chaque fichier changÃ©, vÃ©rifier s'il est dans CODE-DOC-MAP
    while IFS= read -r changed_file; do
        # Convertir en chemin absolu avec ~
        if [[ "$changed_file" == scripts/* ]]; then
            code_path="~/scripts/${changed_file#scripts/}"
        elif [[ "$changed_file" == .claude/commands/* ]]; then
            code_path="~/.claude/commands/${changed_file#.claude/commands/}"
        elif [[ "$changed_file" == .claude/hooks/* ]]; then
            code_path="~/.claude/hooks/${changed_file#.claude/hooks/}"
        elif [[ "$changed_file" == Documents/APP_HOME/.claude/shell-config/* ]]; then
            code_path="~/Documents/APP_HOME/.claude/shell-config/${changed_file#Documents/APP_HOME/.claude/shell-config/}"
        else
            # Fichier non concernÃ© par CODE-DOC-MAP
            continue
        fi

        # VÃ©rifier si ce fichier est dans CODE-DOC-MAP
        if grep -q "| $code_path |" "$CODE_DOC_MAP" 2>/dev/null; then
            # Extraire le fichier doc correspondant
            doc_file=$(grep "| $code_path |" "$CODE_DOC_MAP" | awk -F'|' '{print $3}' | xargs)

            # Convertir chemin doc en chemin git
            doc_git_path="SecondBrain/wiki/tools/$doc_file"

            # VÃ©rifier si doc aussi modifiÃ©e
            if ! echo "$CHANGED_FILES" | grep -q "$doc_file"; then
                DOC_ERRORS=$((DOC_ERRORS + 1))
                MISSING_DOCS="${MISSING_DOCS}\n   - $changed_file â†’ SecondBrain/wiki/tools/$doc_file"
            fi
        fi
    done <<< "$CHANGED_FILES"

    if [ $DOC_ERRORS -gt 0 ]; then
        echo -e "${RED}âœ—${NC}"
        echo -e "   ${RED}ERROR: Code changed but documentation not updated!${NC}"
        echo -e "${MISSING_DOCS}"
        echo ""
        echo "   Fix: Update the corresponding documentation files, or:"
        echo "   - Add them to the commit: git add SecondBrain/wiki/tools/..."
        echo "   - Or bypass with: git commit --no-verify (NOT RECOMMENDED)"
        ERRORS=$((ERRORS + 1))
    else
        echo -e "${GREEN}âœ“${NC}"
    fi
fi

# RÃ©sultat final
echo ""
if [ $ERRORS -gt 0 ]; then
    echo -e "${RED}âŒ Pre-commit check FAILED with $ERRORS error(s)${NC}"
    echo ""
    echo "Fix the errors above before committing."
    echo "Or use 'git commit --no-verify' to bypass (NOT RECOMMENDED)"
    exit 1
else
    echo -e "${GREEN}âœ… All pre-commit checks passed!${NC}"
    exit 0
fi
